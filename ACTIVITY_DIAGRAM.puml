@startuml Activity Diagram

!theme plain
skinparam activityStyle rectangle
skinparam linetype ortho
skinparam roundcorner 10
skinparam shadowing false
skinparam defaultFontSize 11
skinparam arrowThickness 1.5

title Personalized Story Application - Activity Diagram

' ============================================
' STORY PERSONALIZATION FLOW
' ============================================

partition "Story Personalization" {
  start
  
  :Browse/Search Stories;
  
  if (Search by text?) then (yes)
    :Match against reference data;
    if (Match found?) then (yes)
      :Query by situation/topic;
    else (no)
      :Query all stories;
      :Filter by title;
    endif
  else (no)
    :Filter by age/topic/category;
  endif
  
  :Display story results;
  
  :User selects story;
  
  :Load story template;
  
  :Enter child information;
  
  :Select story style;
  
  :Preview personalized story;
  
  if (User confirms?) then (yes)
    :Call personalization API;
    :Personalize template content;
    :Save personalized story;
    :Display personalized story;
    stop
  else (no)
    :Return to edit;
  endif
}

' ============================================
' STORY GENERATION FLOW
' ============================================

partition "Story Generation" {
  start
  
  :Create Story Brief;
  
  :Save brief to Firestore;
  
  :Generate Draft;
  
  :Load story brief;
  
  :Retrieve RAG context;
  
  :Build generation prompt;
  
  :Call OpenAI API;
  
  if (Generation successful?) then (yes)
    :Parse JSON response;
    :Validate draft structure;
    :Save draft to Firestore;
    :Update brief status;
    :Review draft;
    if (Approved?) then (yes)
      :Approve draft;
      :Publish as template;
      stop
    else (no)
      :Request revisions;
    endif
  else (no)
    :Log error;
    :Update draft status to failed;
    stop
  endif
}

@enduml
